{% extends 'templates/dashboard/layout.html' %}
{% load i18n %}
{% load currency_filters %}
{% load customtemplatefilters %}

{% block css %}
    {{ block.super }}
    <link rel="stylesheet" href="{{ STATIC_URL }}css/dashboard/styles.css" xmlns="http://www.w3.org/1999/html"/>
{% endblock css %}

{% block body_class %}{{ block.super }} orders{% endblock %}

{% block title %}
    {% blocktrans with number=order.number %}Order {{ number }}{% endblocktrans %} | {{ block.super }}
{% endblock %}

{% block breadcrumbs %}
    <ul class="breadcrumb">
        <li>
            <a href="{% url 'dashboard:index' %}">{% trans "Dashboard" %}</a>
            <span class="divider"></span>
        </li>
        <li>
            <a href="{% url 'dashboard:order-list' %}">{% trans "Orders" %}</a>
            <span class="divider"></span>
        </li>
        <li class="active">#{{ order.number }}</li>
    </ul>
{% endblock %}

{% block headertext %}
    {% blocktrans with number=order.number %}Order #{{ number }}{% endblocktrans %}
{% endblock  %}

{% block dashboard_content %}

    {% block order_information %}
    <div class="table-header text-center hidden-xs">
        <i class="glyphicon glyphicon-shopping-cart"></i>{% trans "Order information" %}
    </div>
    <table class="collapseTableXS table table-striped table-bordered table-hover">
        <thead>
            <tr>
                <th>{% trans "Order Total" %}</th>
                <th>{% trans "Date of purchase" %}</th>
                <th>{% trans "Time of purchase" %}</th>
                <th>{% trans "Status" %}</th>
            </tr>
        </thead>
        <tbody>
            <tr class="visible-xs text-center" data-toggle="collapse" data-target="#orderInfo">
                <td>
                    <i class="glyphicon glyphicon-shopping-cart"></i> {% trans "Order information" %}
                </td>
            </tr>
            <tr id="orderInfo" class="dashboardCollapse collapse">
                <td class="hidden"></td>
                <td data-th="{% trans "Order Total" %}">{{ order.total_incl_tax|currency:order.currency }}</td>
                <td data-th="{% trans "Date of purchase" %}">{{ order.date_placed|date:"m/d/y" }}</td>
                <td data-th="{% trans "Time of purchase" %}">{{ order.date_placed|date:"H:i" }}</td>
                <td data-th="{% trans "Status" %}">{{ order.status|default:"N/A" }}</td>
            </tr>
        </tbody>
    </table>
    {% endblock order_information %}

    {% block additional_order_information %}
    {% endblock additional_order_information %}

    <div class="sub-header hidden-xs">
        <h2>{% trans "Order Details" %}</h2>
    </div>
    <table class="collapseTableXS table table-striped table-bordered table-hover">
        <tbody>
            <tr class="visible-xs text-center" data-toggle="collapse" data-target="#orderDetails">
                <td>
                    <i class="glyphicon glyphicon-briefcase"></i> {% trans "Order Details" %}
                </td>
            </tr>
        </tbody>
    </table>
    <div id="orderDetails" class="tabbable dashboard dashboardCollapse collapse">
        <ul id="nav-non-xs" class="nav nav-tabs nav-pills hidden-xs">
            {% block nav_tabs_nonxs %}
                <li class="{% if active_tab == 'lines' %}active{% endif %}"><a href="#lines" data-toggle="tab">{% trans "Order contents" %}</a></li>
                <li class="{% if active_tab == 'shipping' %}active{% endif %}"><a href="#shipping" data-toggle="tab">{% trans "Shipping Info" %}</a></li>
                {% if user.is_staff %}
                    <li class="{% if active_tab == 'payment' %}active{% endif %}"><a href="#payment" data-toggle="tab">{% trans "Payment" %}</a></li>
                {% endif %}
                {% if user.is_staff %}
                    <li class="{% if active_tab == 'discounts' %}active{% endif %}"><a href="#discounts" data-toggle="tab">{% trans "Offers" %}</a></li>
                {% endif %}
                {% if user.is_staff %}
                    <li class="{% if active_tab == 'emails' %}active{% endif %}"><a href="#emails" data-toggle="tab">{% trans "Emails" %}</a></li>
                {% endif %}
                <li class="{% if active_tab == 'notes' %}active{% endif %}"><a href="#notes" data-toggle="tab">{% trans "Notes" %}</a></li>
            {% endblock nav_tabs_nonxs %}
        </ul>
        <ul id="nav-xs" class="nav nav-pills nav-stacked visible-xs">
            <li class="text-center dropdown active"><a id="orderContentDropdownHead" href="#" class="dropdown-toggle" data-toggle="dropdown">{% trans "Order contents" %} <span class="caret"></span></a>
                <ul id="orderContentDropdown" class="dropdown-menu" role="menu">
                {% block nav_tabs_xs %}
                    <li class="text-center {% if active_tab == 'lines' %}active{% endif %}"><a href="#lines" data-toggle="tab">{% trans "Order contents" %}</a></li>
                    <li class="text-center {% if active_tab == 'shipping' %}active{% endif %}"><a href="#shipping" data-toggle="tab">{% trans "Shipping" %}</a></li>
                    {% if user.is_staff %}
                        <li class="text-center {% if active_tab == 'payment' %}active{% endif %}"><a href="#payment" data-toggle="tab">{% trans "Payment" %}</a></li>
                    {% endif %}
                    {% if user.is_staff %}
                        <li class="text-center {% if active_tab == 'discounts' %}active{% endif %}"><a href="#discounts" data-toggle="tab">{% trans "Offers" %}</a></li>
                    {% endif %}
                    {% if user.is_staff %}
                        <li class="text-center {% if active_tab == 'emails' %}active{% endif %}"><a href="#emails" data-toggle="tab">{% trans "Emails" %}</a></li>
                    {% endif %}
                    <li class="text-center {% if active_tab == 'notes' %}active{% endif %}"><a href="#notes" data-toggle="tab">{% trans "Notes" %}</a></li>
                {% endblock nav_tabs_xs %}
                </ul>
            </li>
        </ul>

        <div class="tab-content">
            <div class="tab-pane {% if active_tab == 'lines' %}active{% endif %}" id="lines">
                <div class="table-header">
                    <h3>{% trans "Items ordered" %}</h3>
                </div>

                <form id="order_lines_form" name="order_lines_form" action="" method="post" class="form-inline" data-parsley-errors-container=".parsley-container" data-parsley-validate>
                    {% csrf_token %}
                    {% block line_actions %}
{#                        <h3><i class="glyphicon glyphicon-refresh"></i> {% trans "With selected lines" %}:</h3>#}
                        <div class="control-group">
                            <div class="controls">
                                <input type="text" readonly="true" name="shipping_event_type" value="shipped" class="btn btn-group hidden"/>
                                <label class="radio list-inline hidden">
                                    {% trans "with reference" %} <input type="text" name="reference" value="" />
                                </label>
                            </div>
                        </div>

                        <div class="modal fade" id="shipItModal" tabindex="-1" role="dialog" aria-labelledby="shipItModalLabel" aria-hidden="true">
                            <div class="modal-dialog modal-sm">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                                        <h4 class="modal-title" id="shipItModalLabel">Select Shipping Option</h4>
                                    </div>
                                    <div class="modal-body">
                                        {% if box_types and partner_address_exists %}
                                            <div class="btn-group">
                                                <input id="selectedBoxType" type="text" readonly="true"  class="hidden" name="parcel_type" value="noneSelected"/>
                                                <button type="button" id="selectedShippingOption" name="selectedShippingOption" class="btn btn-default dropdown-toggle form-control" data-toggle="dropdown">
                                                    <span data-bind="label">Select One</span>&nbsp;<span class="caret"></span>
                                                </button>
                                                <ul class="dropdown-menu specialDropdown" role="menu" id="shippingOptionSelect">
                                                    {% for box_type in box_types %}
                                                        <li><a name="{{ box_type.type }}" href="#">{{ box_type.name }} {% if box_type.rates.0.rate != "0.00" %} (${{ box_type.rates.0.rate }}){% endif %}</a></li>
                                                    {% endfor %}
                                                </ul>
                                                <div class="parsley-container">
                                                    <div id="weight-input" class="hidden input-group">
                                                        <input data-parsley-type="number" step="0.25" max="70" class="form-control hidden" name="weight" value="" placeholder="Enter Weight (pounds)" data-parsley-required="false" data-parsley-group="weightcalc">
                                                        <span class="input-group-btn hidden">
                                                            <button type="button" value="calculate_shipping_cost" name="order_action" id="calculateShipping" class="btn btn-primary">Calculate</button>
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="panel panel-default">
                                                <div class="panel-heading">The Financials</div>
                                                <table class="table">
                                                    <tbody>
                                                        <tr>
                                                            <td>Order Total</td>
                                                            <td id="orderTotal">{{ order.total_excl_tax|currency:order.currency }}</td>
                                                        </tr>
                                                        <tr>
                                                            <td>New Shipping Costs</td>
                                                            <td id="newShippingCosts">{{ calculated_shipping_cost|currency:order.currency }}</td>
                                                        </tr>
{#                                                        <tr>#}
{#                                                            <td>Other Shipping Costs</td>#}
{#                                                            <td id="otherShippingCosts">{{ order.shipping_excl_tax|currency:order.currency }}</td>#}
{#                                                        </tr>#}
                                                        <tr>
                                                            <td>Total Transaction Fees</td>
                                                            <td id="totalTransactionFees">{{ order.estimated_tinville_cut|currency:order.currency }}</td>
                                                        </tr>
                                                        <tr>
                                                            <td>Take Home</td>
                                                            <td id="takeHome">{{ order.estimated_designer_cut|currency:order.currency }}</td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        {% else %}
                                            <p>No shop shipping address found. Please <a href="{% url 'customer:address-list' %}">set up a new shipping address for your shop.</a></p>
                                        {% endif %}
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                                        <input type="text"  name="line_action" class="btn btn-primary hidden" value="create_shipping_event"/>
                                        <button id="line_action_submit" class="btn btn-primary">Confirm Shipping Option</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endblock line_actions %}
                    {% block order_lines %}
                        <table class="collapseTableXS table table-striped table-bordered table-hover">
                            <thead>
                                <tr>
                                    <th class="hidden partialOrderCol">{% trans "Select Quantity" %}</th>
                                    {% if user.is_staff %}
                                        <th>{% trans "Line ID" %}</th>
                                    {% endif %}
                                    <th>{% trans "Quantity" %}</th>
                                    <th>{% trans "Product" %}</th>
                                    <th>{% trans "Product Size" %}</th>
                                    <th>{% trans "Product Color" %}</th>
                                    {% if user.is_staff %}<th>{% trans "UPC" %}</th>{% endif %}
                                    <th>{% trans "Status" %}</th>
                                    {% if user.is_staff %}<th>{% trans "Supplier" %}</th>{% endif %}
                                    {% if user.is_staff %}<th>{% trans "Supplier SKU" %}</th>{% endif %}
{#                                    <th>{% trans "Est. delivery date" %}</th>#}
                                    <th>{% trans "Price excl tax (before discounts)" %}</th>
{#                                    <th>{% trans "Price inc tax (before discounts)" %}</th>#}
                                    {% if user.is_staff %}<th>{% trans "Actions" %}</th>{% endif %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for line in order.lines.all %}
                                    <tr class="visible-xs" data-toggle="collapse" data-target="#orderline_{{ line.id }}">
                                        <td data-th="Order Line:">
                                            {{ line.id }}
                                        </td>
                                    </tr>
                                    <tr id="orderline_{{ line.id }}" class="dashboardCollapse collapse">
                                        <td class="hidden"></td>
                                        <td data-th="{% trans "Select Quantity" %}" class="hidden partialOrderCol">
                                            <span><input type="checkbox" name="selected_line" checked value="{{ line.id }}" /></span>
                                            {% if "Shipped" in line.shipping_event_breakdown %}
                                                <span><input type="text" class="form-control" name="selected_line_qty_{{ line.id }}" value="{{ line.quantity|subtract:line.shipping_event_breakdown.Shipped.quantity }}" class="col-md-1" size="2" style="width:40px"/></span>
                                            {% else %}
                                                <span><input type="text" class="form-control" name="selected_line_qty_{{ line.id }}" value="{{ line.quantity }}" class="col-md-1" size="2" style="width:40px" /></span>
                                            {% endif %}
                                        </td>
                                        {% if user.is_staff %}
                                            <td class="hidden-xs"><a href="{% url 'dashboard:order-line-detail' number=order.number line_id=line.id %}">#{{ line.id }}</a></td>
                                        {% endif %}
                                        <td data-th="{% trans "Quantity" %}">{{ line.quantity }}</td>
                                        <td data-th="{% trans "Product" %}">
                                            {% if user.is_staff %}
                                                {% if line.product %}
                                                    <a href="{% url 'dashboard:catalogue-product' pk=line.product.id %}">{{ line.title }}</a>
                                                {% else %}
                                                    {{ line.title }}
                                                {% endif %}
                                            {% else %}
                                                {{ line.title }}
                                            {% endif %}
                                        </td>
                                        <td data-th="{% trans "Product Size" %}">
                                            {% for attribute in line.product.attribute_values.all %}
                                                {% if attribute.attribute.name == "size_set" %}
                                                    {{  attribute.value|upper }}
                                                {% endif %}

                                                {% if attribute.attribute.name == "size_number" %}
                                                    {{  attribute.value }}
                                                {% endif %}

                                                {% if attribute.attribute.name == "size_dimension_x" %}
                                                    {{  attribute.value }}
                                                {% endif %}

                                                {% if attribute.attribute.name == "size_dimension_y" %}
                                                    x {{  attribute.value }}
                                                {% endif %}
                                            {% endfor %}
                                        </td>
                                        <td data-th="{% trans "Product Color" %}">
                                            {% for attribute in line.product.attribute_values.all %}
                                                {% if attribute.attribute.name == "color" %}
                                                    {{  attribute.value|title }}
                                                {% endif %}
                                            {% endfor %}
                                        </td>
                                        {% if user.is_staff %}<td data-th="{% trans "UPC" %}">{{ line.upc|default:"-" }}</td>{% endif %}
                                        <td data-th="{% trans "Status" %}">{{ line.status|default:"-" }}</td>
                                        {% if user.is_staff %}
                                        <td data-th="{% trans "Supplier" %}">
                                            {% if line.partner %}
                                                <a href="{% url 'dashboard:partner-manage' pk=line.partner.id %}">{{ line.partner_name }}</a>
                                            {% else %}
                                                {{ line.partner_name }}
                                            {% endif %}
                                        </td>
                                        {% endif %}
                                        {% if user.is_staff %}<td data-th="{% trans "Supplier SKU" %}">{{ line.partner_sku }}</td>{% endif %}
{#                                        <td data-th="{% trans "Est. delivery date" %}">{{ line.est_dispatch_date|default:"-" }}</td>#}
                                        <td data-th="{% trans "Price excl tax (before discounts)" %}" style="text-align: right">{{ line.line_price_before_discounts_excl_tax|currency:order.currency }}</td>
{#                                        <td data-th="{% trans "Price inc tax (before discounts)" %}" style="text-align: right">{{ line.line_price_before_discounts_incl_tax|currency:order.currency }}</td>#}
                                        {% if user.is_staff %}
                                            <td data-th="{% trans "Actions" %}">
                                                <a href="{% url 'dashboard:order-line-detail' number=order.number line_id=line.id %}" class="btn btn-primary">{% trans "View" %}</a>
                                            </td>
                                        {% endif %}
                                    </tr>
                                {% endfor %}
                                <tr class="visible-xs" data-toggle="collapse" data-target=".ordertotals">
                                     <td data-th="{% trans "Order total" %} incl tax" style="text-align: right">{{ order.total_incl_tax|currency:order.currency }} (expand for details)</td>
                                </tr>
                                <tr class="ordertotals dashboardCollapse collapse">
                                    <td class="hidden-xs" colspan="3"></td>
                                    <th class="hidden-xs">{% trans "Discount" %}</th>
                                    <td data-th="{% trans "Discount" %} excl tax" style="text-align: right">{{ order.total_discount_excl_tax|currency:order.currency }}</td>
{#                                    <td data-th="{% trans "Discount" %} incl tax" style="text-align: right">{{ order.total_discount_incl_tax|currency:order.currency }}</td>#}
                                    <td class="hidden-xs"></td>
                                </tr>

                                <tr class="ordertotals dashboardCollapse collapse">
                                    <td class="hidden-xs" colspan="3"></td>
                                    <th class="hidden-xs">{% trans "Order total" %}</th>
                                    <td data-th="{% trans "Order total" %} excl tax" style="text-align: right">{{ order.total_excl_tax|currency:order.currency }}</td>
{#                                    <td data-th="{% trans "Order total" %} incl tax" style="text-align: right">{{ order.total_incl_tax|currency:order.currency }}</td>#}
                                    <td class="hidden-xs"></td>
                                </tr>


                                {% if order.has_shipping_discounts %}
                                    <tr class="ordertotals dashboardCollapse collapse">
                                        <td class="hidden-xs" colspan="3"></td>
                                        <td class="hidden-xs">{% trans "Shipping total (excl. discounts)" %}</td>
                                        <td data-th="{% trans "Shipping total (excl. discounts) excl tax" %}" style="text-align: right">{{ order.shipping_before_discounts_excl_tax|currency:order.currency }}</td>
{#                                        <td data-th="{% trans "Shipping total (excl. discounts) incl tax" %}" style="text-align: right">{{ order.shipping_before_discounts_incl_tax|currency:order.currency }}</td>#}
                                        <td class="hidden-xs"></td>
                                    </tr>
                                    {% for discount in order.shipping_discounts %}
                                        <tr class="ordertotals dashboardCollapse collapse">
                                            <td class="hidden-xs" colspan="3"></td>
                                            <td>
                                                <span class="label label-success">{% trans "Discount" %}</span>
                                                {{ discount.offer_name }}
                                            </td>
                                            <td class="hidden-xs"></td>
                                            <td data-th="hello" style="text-align: right">- {{ discount.amount|currency:order.currency }}</td>
                                            <td class="hidden-xs"></td>
                                        </tr>
                                    {% endfor %}
                                    <tr class="ordertotals dashboardCollapse collapse">
                                        <td class="hidden-xs" colspan="3"></td>
                                        <th class="hidden-xs">{% trans "Shipping total (inc. discounts)" %}</th>
                                        <td data-th="{% trans "Shipping total (inc. discounts)" %} excl tax" style="text-align: right">{{ order.shipping_excl_tax|currency:order.currency }}</td>
{#                                        <td data-th="{% trans "Shipping total (inc. discounts)" %} incl tax" style="text-align: right">{{ order.shipping_incl_tax|currency:order.currency }}</td>#}
                                        <td class="hidden-xs"></td>
                                    </tr>
                                {% else %}
                                    <tr class="ordertotals dashboardCollapse collapse">
                                        <td class="hidden-xs" colspan="3"></td>
                                        <th class="hidden-xs" >{% trans "Shipping total" %}</th>
                                        <td data-th="{% trans "Shipping total" %}" style="text-align: right">{{ order.shipping_excl_tax|currency:order.currency }}</td>
{#                                        <td data-th="{% trans "Shipping total" %} incl tax" style="text-align: right">{{ order.shipping_incl_tax|currency:order.currency }}</td>#}
                                        <td class="hidden-xs" ></td>
                                    </tr>
                                {% endif %}
                                <tr class="ordertotals dashboardCollapse collapse">
                                    <td class="hidden-xs" colspan="3"></td>
                                    <th class="hidden-xs">{% trans "Tinville cut total" %}</th>
                                    <td data-th="{% trans "Tinville cut total" %}" style="text-align: right"> {% if order.status == 'Shipped' %}{{ order.estimated_tinville_cut|currency:order.currency }} {% else %} {% trans "Pending shipping" %} {% endif %}</td>
                                    <td class="hidden-xs"></td>
                                </tr>
                                <tr class="ordertotals dashboardCollapse collapse">
                                    <td class="hidden-xs" colspan="3"></td>
                                    <th class="hidden-xs">{% trans "Take home total" %}</th>
                                    <td data-th="{% trans "Take home total" %}" style="text-align: right">{{ order.estimated_designer_cut|currency:order.currency }}</td>
                                    <td class="hidden-xs"></td>
                                </tr>
                                {% if discounts %}
                                    {% with discounts=order.basket_discounts %}
                                        {% if discounts %}
                                            <tr class="ordertotals dashboardCollapse collapse">
                                                <td class="hidden-xs" colspan="3"></td>
                                                <th class="hidden-xs">{% trans "Basket total (excl. discounts)" %}</th>
                                                <td data-th="{% trans "Basket total (excl. discounts)" %}" style="text-align: right">{{ order.basket_total_before_discounts_excl_tax|currency:order.currency }}</td>
    {#                                            <td data-th="{% trans "Basket total (excl. discounts)" %} incl tax" style="text-align: right">{{ order.basket_total_before_discounts_incl_tax|currency:order.currency }}</td>#}
                                                <td class="hidden-xs"></td>
                                            </tr>
                                            {% for discount in discounts %}
                                                <tr class="ordertotals dashboardCollapse collapse">
                                                    <td class="hidden-xs" colspan="3"></td>
                                                    <td>
                                                        <span class="label label-success">{% trans "Discount" %}</span>
                                                        {{ discount.offer_name }}
                                                    </td>
                                                    <td style="text-align: right"></td>
                                                    <td data-th="{% trans "Discount" %}" style="text-align: right">- {{ discount.amount|currency:order.currency }}</td>
                                                    <td class="hidden-xs"></td>
                                                </tr>
                                            {% endfor %}
                                            <tr class="ordertotals dashboardCollapse collapse">
                                                <td class="hidden-xs" colspan="3"></td>
                                                <th class="hidden-xs">{% trans "Basket total (inc. discounts)" %}</th>
                                                <td class="hidden-xs" style="text-align: right">{{ order.basket_total_excl_tax|currency:order.currency }}</td>
    {#                                            <td class="hidden-xs" style="text-align: right">{{ order.basket_total_incl_tax|currency:order.currency }}</td>#}
                                                <td class="hidden-xs"></td>
                                            </tr>
                                        {% else %}
                                            <tr class="ordertotals dashboardCollapse collapse">
                                                <td class="hidden-xs" colspan="3"></td>
                                                <th class="hidden-xs">{% trans "Basket total" %}</th>
                                                <td data-th="{% trans "Basket total" %}" style="text-align: right">{{ order.basket_total_excl_tax|currency:order.currency }}</td>
    {#                                            <td data-th="{% trans "Basket total" %} incl tax" style="text-align: right">{{ order.basket_total_incl_tax|currency:order.currency }}</td>#}
                                                <td class="hidden-xs"></td>
                                            </tr>
                                        {% endif %}
                                    {% endwith %}
                                {% endif %}

                                <tr>
                                    <td colspan="8">
                                        <div class="btn-group pull-right">
                                            {% ifnotequal order.status "Shipped" %}
                                            <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#shipItModal">Ship my order!</button>
                                            {% endifnotequal %}
                                        </div>
                                        <div class="pull-left hidden">
                                            <input type="checkbox" id="partialOrder"/>
                                            <label>Ship partial order</label>
                                        </div>
                                    </td>

                                </tr>
                            </tbody>

                        </table>
                    {% endblock order_lines %}
                </form>

                {% block shipping_events %}
                    <div class="table-header">
                        <h3>{% trans "Shipping Events" %}</h3>
                    </div>
                    {% with events=order.shipping_events.all %}
                        <table class="table table-striped table-bordered table-hover collapseTableXS">
                            {% if events %}
                                <thead>
                                    <tr>
                                        <th>{% trans "Date" %}</th>
                                        <th>{% trans "Event" %}</th>
                                        <th>{% trans "Lines" %}</th>
                                        <th>{% trans "Tracking Code" %}</th>
                                        <th>{% trans "Actions" %}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for event in events %}
                                        {% with line_qtys=event.line_quantities.all %}
                                            <tr class="visible-xs" data-toggle="collapse" data-target="#shippingevent_{{ event.id }}">
                                                <td data-th="{% trans "Date" %}">
                                                    {{ event.date_created }}
                                                </td>
                                            </tr>
                                            <tr id="shippingevent_{{ event.id }}" class="dashboardCollapse collapse">
                                                <td class="hidden"></td>
                                                <td class="hidden-xs" data-th="{% trans "Date" %}">{{ event.date_created }}</td>
                                                <td data-th="{% trans "Event" %}">{{ event.event_type.name }}</td>
                                                <td data-th="{% trans "Lines" %}">
                                                    {% for line_qty in event.line_quantities.all %}
                                                        <a href="{% url 'dashboard:order-line-detail' number=order.number line_id=line_qty.line.id %}">
                                                            {% blocktrans with title=line_qty.line.title event_qty=line_qty.quantity total_qty=line_qty.line.quantity %}
                                                                {{ title }} (quantity {{ event_qty }}/{{ total_qty }})
                                                            {% endblocktrans %}
                                                        </a>
                                                    {% endfor %}
                                                </td>
                                                <td data-th="Tracking Number">{{ event.tracking_code|default:"-" }}</td>
                                                <td data-th="{% trans "Actions" %}">
                                                    {% if event.event_type.code == 'shipped' %}
{#                                                        <div class="btn-group" role="group" aria-label="...">#}
                                                            {% if not request.mobile %}
                                                                <button type="button" id="print_label_{{ event.id }}" class="btn btn-primary">{% trans "Print Label" %}</button>
                                                            {% else %}
                                                                Printing not available on mobile
                                                            {% endif %}
                                                            <img src="{{ event.label_url }}" class="hidden printLabel">
                                                            {% if user.is_staff %}
                                                                <button type="button" id="cancel_label_{{ event.id }}" class="btn btn-primary">{% trans "Cancel Label" %}</button>
                                                            {% endif %}

{#                                                        </div>#}
                                                    {% endif %}
                                                </td>
                                            </tr>
                                        {% endwith %}
                                    {% endfor %}
                                </tbody>
                            {% else %}
                                <tbody>
                                    <tr>
                                        <td>{% trans "No shipping events." %}</td>
                                    </tr>
                                </tbody>
                            {% endif %}
                        </table>
                    {% endwith %}
                {% endblock %}

{#                {% if user.is_staff %}#}
                    {% block payment_events %}
                        <div class="table-header">
                            <h3 >{% trans "Payment Events" %}</h3>
                        </div>
                        {% with events=order.payment_events.all %}
                            <table class="table table-striped table-bordered table-hover collapseTableXS">
                                {% if events %}
                                    <thead>
                                        <tr>
                                            <th>{% trans "Date" %}</th>
                                            <th>{% trans "Event" %}</th>
                                            <th>{% trans "Amount" %}</th>
                                            <th>{% trans "Lines" %}</th>
                                            <th>{% trans "Reference" %}</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for event in events %}
                                            {% with line_qtys=event.line_quantities.all %}
                                                <tr class="visible-xs" data-toggle="collapse" data-target="#paymentevent_{{ event.id }}">
                                                    <td data-th="{% trans "Date" %}">
                                                        {{ event.date_created }}
                                                    </td>
                                                </tr>
                                                <tr id="paymentevent_{{ event.id }}" class="dashboardCollapse collapse">
                                                    <td class="hidden"></td>
                                                    <td class="hidden-xs">{{ event.date_created }}</td>
                                                    <td data-th="{% trans "Event" %}">{{ event.event_type.name }}</td>
                                                    <td data-th="{% trans "Amount" %}">{{ event.amount|currency:order.currency }}</td>
                                                    <td data-th="{% trans "Lines" %}">
                                                        {% for line_qty in event.line_quantities.all %}
                                                            {% trans "Product:" %} {{ line_qty.line.title }} - {% trans "quantity" %} {{ line_qty.quantity }}</br>
                                                        {% endfor %}
                                                    </td>
                                                    <td data-th="{% trans "Reference" %}">{{ event.reference|default:"-" }}</td>
                                                </tr>
                                            {% endwith %}
                                        {% endfor %}
                                    </tbody>
                                {% else %}
                                    <tbody>
                                        <tr><td>{% trans "No payment events." %}</td></tr>
                                    </tbody>
                                {% endif %}
                            </table>
                        {% endwith %}
                    {% endblock %}
{#                {% endif %}#}
            </div>

            <div class="tab-pane {% if active_tab == 'shipping' %}active{% endif %}" id="shipping">
                {% block tab_shipping %}
                    <div class="table-header hidden-xs">
                        <h3>{% trans "Shipping" %}</h3>
                    </div>
                    <table class="table table-striped table-bordered table-hover collapseTableXS">
                        <tbody>
                            {% if user.is_staff %}
                            <tr>
                                <th class="hidden-xs">{% trans "Method name" %}</th>
                                <td data-th="{% trans "Method name" %}">{{ order.shipping_method }}</td>
                            </tr>
                            {% endif %}
                            {% if user.is_staff %}
                            <tr>
                                <th class="hidden-xs">{% trans "Method code" %}</th>
                                <td data-th="{% trans "Method code" %}">{{ order.shipping_code|upper }}</td>
                            </tr>
                            {% endif %}
                            {% if user.is_staff %}
                            <tr>
                                <th class="hidden-xs">{% trans "Charge (incl tax)" %}</th>
                                <td data-th="% {% trans "Charge (incl tax)" %}">{{ order.shipping_incl_tax|currency:order.currency }}</td>
                            </tr>
                            {% endif %}
                            <tr>
                                <th class="hidden-xs">{% trans "Charge (excl tax)" %}</th>
                                <td data-th="{% trans "Charge (excl tax)" %}">{{ order.shipping_excl_tax|currency:order.currency }}</td>
                            </tr>
                            <tr>
                                <th class="hidden-xs">{% trans "Address" %}</th>
                                <td data-th="{% trans "Address" %}">
                                    {% for field in order.shipping_address.active_address_fields %}
                                        {{ field }}<br/>
                                    {% endfor %}
                                </td>
                            </tr>
                            <tr>
                                <th class="hidden-xs">{% trans "Phone" %}</th>
                                <td data-th="{% trans "Phone" %}">{{ order.shipping_address.phone_number|default:"-" }}</td>
                            </tr>
                            {% if user.is_staff %}
                            <tr>
                                <th class="hidden-xs">{% trans "Instructions" %}</th>
                                <td data-th="{% trans "Instructions" %}">{{ order.shipping_address.notes|default:"-"|linebreaks }}</td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                {% endblock %}
            </div>

            <div class="tab-pane {% if active_tab == 'payment' %}active{% endif %}" id="payment">
                {% block tab_payment %}

                    {% if order.billing_address %}
                        <div class="sub-header hidden-xs">
                            <h3 >{% trans "Billing address" %}</h3>
                        </div>
                        <p>
                            {% for field in order.billing_address.active_address_fields %}
                                {{ field }}<br/>
                            {% endfor %}
                        </p>
                    {% endif %}

                    {% with sources=order.sources.all %}
                        {% if sources %}
                            <div class="table-header hidden-xs">
                                <h3 >{% trans "Payment sources" %}</h3>
                            </div>

                            <table class="table table-striped table-bordered table-hover collapseTableXS">
                                <thead>
                                    <tr>
                                        <th>{% trans "Source" %}</th>
                                        <th>{% trans "Allocation" %}</th>
                                        <th>{% trans "Amount debited" %}</th>
                                        <th>{% trans "Amount refunded" %}</th>
                                        <th>{% trans "Reference" %}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for source in sources %}
                                        <tr>
                                            <td class="hidden"></td>
                                            <td data-th="{% trans "Source" %}">{{ source.source_type }}</td>
                                            <td data-th="{% trans "Allocation" %}">{{ source.amount_allocated|currency:order.currency }}</td>
                                            <td data-th="{% trans "Amount debited" %}">{{ source.amount_debited|currency:order.currency }}</td>
                                            <td data-th="{% trans "Amount refunded" %}">{{ source.amount_refunded|currency:order.currency }}</td>
                                            <td data-th="{% trans "Reference" %}">{{ source.reference|default:"-" }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        {% else %}
                            <p>{% trans "No payment sources found for this order." %}</p>
                        {% endif %}
                    {% endwith %}

                    {% block payment_transactions %}
                        {% if payment_transactions %}
                            <div class="table-header">
                                <h3>{% trans "Transactions" %}</h3>
                            </div>
                            <table class="table table-striped table-bordered table-hover">
                                <thead>
                                    <tr>
                                        <th>{% trans "Source" %}</th>
                                        <th>{% trans "Amount" %}</th>
                                        <th>{% trans "Reference" %}</th>
                                        <th>{% trans "Status" %}</th>
                                        <th>{% trans "Date" %}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for txn in payment_transactions %}
                                        <tr>
                                            <td>{{ txn.source.source_type }}</td>
                                            <td>{{ txn.amount|currency:order.currency }}</td>
                                            <td>{{ txn.reference|default:"-" }}</td>
                                            <td>{{ txn.status|default:"-" }}</td>
                                            <td>{{ txn.date_created }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        {% endif %}
                    {% endblock %}

                {% endblock %}
            </div>

            {% if user.is_staff %}
                <div class="tab-pane {% if active_tab == 'discounts' %}active{% endif %}" id="discounts">
                    {% block tab_discounts %}

                        {% with discounts=order.discounts.all %}
                            <div class="table-header hidden-xs">
                                <h3>{% trans "Offer applications" %}</h3>
                            </div>
                            <table class="table table-striped table-bordered table-hover collapseTableXS">
                                <thead>
                                    <tr>
                                        <th>{% trans "Type" %}</th>
                                        <th>{% trans "Voucher" %}</th>
                                        <th>{% trans "Offer name" %}</th>
                                        <th>{% trans "Frequency" %}</th>
                                        <th>{% trans "Message" %}</th>
                                        <th>{% trans "Amount" %}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                {% if discounts %}
                                    {% for discount in discounts %}
                                        <tr>
                                            <td data-th="{% trans "Type" %}">{{ discount.get_category_display }}</td>
                                            <td data-th="{% trans "Voucher" %}">
                                                {{ discount.voucher.code|default:"-" }}
                                            </td>
                                            <td data-th="{% trans "Offer name" %}">
                                                {% if discount.offer %}
                                                    <a href="{% url 'dashboard:offer-detail' pk=discount.offer.id %}">{{ discount.offer.name }}</a>
                                                {% else %}
                                                    {{ discount.offer_name }}
                                                {% endif %}
                                            </td>
                                            <td data-th="{% trans "Frequency" %}">{{ discount.frequency }}</td>
                                            <td data-th="{% trans "Message" %}">{{ discount.message|default:"-" }}</td>
                                            <td data-th="{% trans "Amount" %}">{{ discount.amount|currency:order.currency }}</td>
                                        </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td class="hidden"></td>
                                        <td class="text-center">{% trans "No offer data available." %}</td>
                                    </tr>
                                {% endif %}
                                </tbody>
                            </table>
                        {% endwith %}

                    {% endblock %}
                </div>
            {% endif %}

            {%  if user.is_staff %}
                <div class="tab-pane {% if active_tab == 'emails' %}active{% endif %}" id="emails">
                    {% block tab_emails %}
                        <div class="table-header">
                            <h3>{% trans "Emails" %}</h3>
                        </div>
                        <table class="table table-striped table-bordered table-hover">
                            <tr><td>{% trans "No email data available." %}</td></tr>
                        </table>
                    {% endblock %}
                </div>
            {% endif %}

            <div class="tab-pane {% if active_tab == 'notes' %}active{% endif %}" id="notes">
                {% block tab_notes %}
                    <div class="table-header hidden-xs">
                        <h3>{% trans "Notes" %}</h3>
                    </div>
                    {% with notes=order.notes.all %}
                        <table class="table table-striped table-bordered table-hover collapseTableXS">
                            {% if notes %}
                                <thead>
                                    <tr>
                                        <th>{% trans "Date" %}</th>
                                        <th>{% trans "User" %}</th>
                                        <th>{% trans "Type" %}</th>
                                        <th>{% trans "Message" %}</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                {% for note in notes %}
                                    <tr class="visible-xs" data-toggle="collapse" data-target="#note_{{ note.id }}">
                                        <td data-th="{% trans "Date" %}">
                                            {{ note.date_created }}
                                        </td>
                                    </tr>
                                    <tr id="note_{{ note.id }}" class="dashboardCollapse collapse">
                                        <td class="hidden-xs">{{ note.date_created }}</td>
                                        <td data-th="{% trans "User" %}">{{ note.user|default:"-" }}</td>
                                        <td data-th="{% trans "Type" %}">{{ note.note_type|default:"-" }}</td>
                                        <td data-th="{% trans "Message" %}">{{ note.message|linebreaks }}</td>
                                        <td class="col-md-2 col-xs-12">
                                            {% if note.is_editable %}
                                                &nbsp;<a href="{% url 'dashboard:order-detail-note' number=order.number note_id=note.id %}#notes" class="btn btn-primary">{% trans "Edit" %}</a>
                                                <form action="" method="post" class="pull-left">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="order_action" value="delete_note" />
                                                    <input type="hidden" name="note_id" value="{{ note.id }}" />
                                                    <input type="submit" value="{% trans "Delete" %}" class="btn btn-danger" />
                                                </form>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td>{% trans "No notes available." %}</td>
                                </tr>
                            {% endif %}
                        </table>
                    {% endwith %}

                    <form action="?note={{ note_id }}" method="post" class="form-stacked">
                        {% csrf_token %}
                        <input type="hidden" value="save_note" name="order_action" />
                        {% include "partials/form_fields.html" with form=note_form %}
                        <!-- {{ note_form.as_p }} -->
                        <div class="form-actions">
                            <input type="submit" value="{% trans "Save note" %}" class="btn btn-primary" />
                            {% trans "Notes are only editable for 5 minutes after being saved." %}
                        </div>
                    </form>
                {% endblock %}
            </div>

            {% block extra_tabs %}{% endblock %}
        </div>
    </div>
    {% block customer_information %}
    <div class="table-header text-center hidden-xs">
        <i class="glyphicon glyphicon-user"></i>{% trans "Customer Information" %}
    </div>
    <table class="collapseTableXS table table-striped table-bordered table-hover">
        <thead>
            {% if order.guest_email %}
                <tr><td>{% trans "Customer checked out as a guest." %}</td></tr>
            {% elif order.user %}
                <tr>
                    {% if user.is_staff %}
                        <th>{% trans "Name" %}</th>
                    {% endif %}
                    <th>{% trans "Email address" %}</th>
                </tr>
        </thead>
            <tbody>
                <tr class="visible-xs text-center" data-toggle="collapse" data-target="#customerInfo">
                    <td>
                        <i class="glyphicon glyphicon-user"></i> {% trans "Customer Information" %}
                    </td>
                </tr>
                <tr id="customerInfo" class="dashboardCollapse collapse">
                    <td class="hidden"></td>
                    {% if user.is_staff %}
                        <td data-th="{% trans "Name" %}">{{ order.user.get_full_name|default:"-" }}</td>
                    {% endif %}
                    <td data-th="{% trans "Email address" %}">{{ order.user.email|default:"-" }}</td>
                </tr>
            {% else %}
                <tr><td>{% trans "Customer has deleted their account." %}</td></tr>
            {% endif %}
            </tbody>
    </table>
    {% endblock customer_information %}

{% endblock dashboard_content %}

{% block onbodyload %}
    {{ block.super }}
    oscar.dashboard.orders.initTabs();
    oscar.dashboard.orders.initTable();
{% endblock %}


{% block javascript %}
    {{ block.super }}
    <script>

        $("#shippingOptionSelect").on( 'click', 'li', function() {
            var selectedShippingOption = $(this).find('a').attr('name');
            var box_types = JSON.parse("{{ box_types_json|escapejs }}");
            for (var box_type in box_types)
            {
                if (box_types[box_type].type == selectedShippingOption)
                {
                    $("#selectedBoxType").attr("value", box_types[box_type].type);
                    setModalCosts(box_types[box_type].rates[0].rate)
                }
                if (selectedShippingOption == "Parcel")
                {
                    $("#weight-input").removeClass("hidden");
                    $("#weight-input>*").removeClass("hidden");
                    $("#weight-input>*").attr('data-parsley-required', 'true');
                }
                else
                {
                    $("#weight-input").addClass("hidden");
                    $("#weight-input>*").addClass("hidden");
                    $("#weight-input>*").attr('data-parsley-required', 'false');
                    $("[name='weight']").val('');
                }
            }
        });

        $("[id^='print_label_']").click(function (){
            myprintlabel = this.nextElementSibling;
            printElement(myprintlabel);
            var modThis = document.querySelector("#printSection .printLabel");
            modThis.className = "printLabel";
            window.print();
        });

        function setModalCosts(newShippingCost) {
            $("#newShippingCosts").text("$" + newShippingCost)
            var totalTransactionFees = (($("#orderTotal").text().substring(1)-
                $("#newShippingCosts").text().substring(1)-
                $("#otherShippingCosts").text().substring(1))*0.2).toFixed(2)
            var totalTakeHome = ($("#orderTotal").text().substring(1)-
                $("#newShippingCosts").text().substring(1)-
                $("#otherShippingCosts").text().substring(1)-
                totalTransactionFees).toFixed(2)
            if(totalTakeHome >= 0)
            {
                $("#takeHome").text("$" + totalTakeHome)
            }
            else
            {
                $("#takeHome").text("-$" + Math.abs(totalTakeHome).toFixed(2))
            }
            $("#totalTransactionFees").text("$" + totalTransactionFees)
        }
        $("#calculateShipping").click(function(){
            "use strict";
            var $form = $('#order_lines_form');
            if ( $form.parsley().validate('weightcalc'))
            {
                var postData = $( "#order_lines_form" ).serialize()
                postData = postData + "&order_action=calculate_shipping_cost"
                $("#calculateShipping").html('<span class="glyphicon glyphicon-refresh glyphicon-refresh-animate"></span> Calculating...')
                $.post("", postData)
                    .done(function(data){
                        $("#calculateShipping").html('Calculate')
                        setModalCosts(data)
                    });
            }
        });

        $("#line_action_submit").click(function (){
            var $form = $('#order_lines_form');
            if ( $form.parsley().validate('weightcalc') )
            {
                $("#processing-modal").modal('show');
                $("#order_lines_form").submit();
            }
        });

        $("#partialOrder").click( function(){
            if( $(this).is(':checked') ){
                $("[colspan='3']").attr("colspan", "4")
                $("[colspan='8']").attr("colspan", "7")
                $(".partialOrderCol").removeClass("hidden");
            }
            else
            {
                $("[colspan='4']").attr("colspan", "3")
                $("[colspan='7']").attr("colspan", "8")
                $(".partialOrderCol").addClass("hidden")
            }
        });

{#        $('#line_action_submit').parsley({#}
{#            errorsContainer: function (el) {#}
{#                return el.$element.closest(".input-group");#}
{#            }#}
{#        });#}
    </script>
{% endblock %}
