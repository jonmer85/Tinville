{% extends "designer_shop/shopper.html" %}
{% load i18n %}
{% block css %}
    <link rel="stylesheet" href="{{ STATIC_URL }}css/designer_shop/styles.css" />
    <script src="//tinville-dev.s3.amazonaws.com/static/js/tiny_mce/tiny_mce.js"></script>
    <link rel="stylesheet" href="{{ STATIC_URL }}css/farbtastic.css" />
    <link href="{{ STATIC_URL }}css/cropper.css" rel="stylesheet">
{% endblock css %}
{% block uncompressable_css %}
    {{ aboutBoxForm.media }}
{% endblock uncompressable_css %}
{% block js_to_run_before_body  %}
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
{% endblock js_to_run_before_body  %}
{% block content %}
{{ block.super }}
    <div class="modal fade" id="mobileModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                    <h4 class="modal-title" id="mobileModalLabel">Mobile Shop Editor</h4>
                </div>
                <div class="modal-body">
                    Mobile shop editor is experimental. For best results use a PC, Mac, or a larger tablet such as an iPad.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="bannerUploadModal" tabindex="-1" role="dialog" aria-labelledby="bannerUploadModalLabel" data-backdrop="static" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="bannerUploadModalLabel">Upload Your Banner</h4>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <form class="tab-pane col-xs-12" id="banner" enctype="multipart/form-data" method="post">
                            {% load crispy_forms_tags %}
                            {% crispy bannerUploadForm %}
                        </form>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="bannerModalFooterSubmit" type="button" class="btn btn-primary tinvilleButton" onclick="$('#id_SubmitBanner').click()">Submit</button>
                    <button type="button" class="btn btn-defaultnumber" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="colorPickerModal" tabindex="-1" role="dialog" aria-labelledby="colorPickerModalLabel" data-backdrop="static" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="colorPickerModalLabel">Choose your Color</h4>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <form class="tab-pane col-xs-12" id="color" action="ajax_color" method="post">
                            {% load crispy_forms_tags %}
                            {% crispy designerShopColorPicker %}
                        </form>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="colorModalFooterSubmit" type="button" class="btn btn-primary tinvilleButton" data-dismiss="modal" onclick="$('#id_ShopColorPicker').click()">Submit</button>
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <div id="shopEditor_message_area" class="col-middle col-xs-height"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="aboutBoxModal" tabindex="-1" role="dialog" aria-labelledby="aboutBoxModalLabel" data-backdrop="static" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="aboutBoxModalLabel">Edit About You</h4>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <form class="tab-pane row active col-xs-12" id="about" enctype="multipart/form-data" method="post">
                             {% load crispy_forms_tags %}
                             {% crispy aboutBoxForm %}
                        </form>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="aboutModalFooterSubmit" type="button" class="btn btn-primary tinvilleButton" onclick="$('#id_SubmitAboutContent').click()">Submit</button>
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="productCreationModal" tabindex="-1" role="dialog" aria-labelledby="productCreationLabel" data-backdrop="static" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="productCreationModalLabel">Add Item</h4>
                </div>
                <div class="modal-body" id="productCreationForm">
                    <div class="row">
                        <form novalidate="novalidate" class="tab-pane row col-xs-12" action="{% if editItemMode %}{{ url_path }}{% endif %}" class="tab-pane" id="addOrEditItem" enctype="multipart/form-data" method="post">
                            {% load crispy_forms_tags %}
                            {% crispy productCreationForm %}
                        </form>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="itemModalFooterSubmit" type="button" class="btn btn-primary tinvilleButton" onclick="$('#id_SubmitAddEditItem').click()">Submit</button>
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                    <h4 class="modal-title" id="myModalLabel">Delete Item</h4>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <button id="okDeleteBtn" type="button" class="btn btn-primary">OK</button>
                </div>
            </div>
        </div>
    </div>


    {% include "designer_shop/shipping_price_guide.html" %}

{% endblock %}

{% block javascript_library %}
    {{ block.super }}
    <script src="{{ STATIC_URL }}js/vendor/cropper.js"></script>
    <script src="{{ STATIC_URL }}js/vendor/farbtastic.js"></script>

{% endblock javascript_library %}

{% block javascript %}
    {{ block.super }}
    <script>
        $(document).on("change","#id_product_image",function() {
            $("#id_product_image1").removeClass("hidden");
        });

        $(document).on("change","#id_product_image1",function() {
            $("#id_product_image2").removeClass("hidden");
        });

        $(document).on("change","#id_product_image2",function() {
            $("#id_product_image3").removeClass("hidden");
        });

        $(document).on("change","#id_product_image3",function() {
            $("#id_product_image4").removeClass("hidden");
        });

        $("#emptyShopCon").css("border-style", "dashed");
        $("#emptyShopCon").css("border-color", "darkgray");
        $("#emptyShopCon").css("margin-bottom", "30px");
        $("#shopTabLink").removeClass("active");
        $("#aboutTabLink").removeClass("active");
        $("#editLink").addClass("active");

        $(document).on("submit", "#color", function(e) {
            e.preventDefault();
            var self = $(this);
            var url = self.attr("action");
            var ajax_req = $.ajax({
                url: url,
                type: "POST",
                data: {
                    color: document.getElementById("id_color").value
                },
                success: function(data, textStatus, jqXHR) {
                    clear_django_messages(self.find("#shopEditor_message_area"));
                    clear_form_field_errors("#color");
                    $(".shopColor").css("color", document.getElementById("id_color").value);
                    $(".shopBackgroundColor").css("background-color", document.getElementById("id_color").value);
                    var textColor = isTooLightYIQ(document.getElementById("id_color").value) ? '#777' : '#e7e5e6';
                    $(".shopTitleColor").css("color", textColor);
                },
                error: function(data, textStatus, jqXHR) {
                    clear_django_messages(self.find("#shopEditor_message_area"));
                    clear_form_field_errors("#color");
                    document.getElementById('shopEditor_message_area').innerHTML = "";
                    var errors = $.parseJSON(data.responseText);
                    $.each(errors, function(index, value) {
                        if (index === "__all__") {
                            django_message(value[0], "error", self.find("#shopEditor_message_area"));
                        } else {
                            apply_form_field_error(self[0].id, index, value);
                        }
                    });
                }
            });
        });


        var resetEditFormParsley = function () {
            $('#addOrEditItem').parsley().subscribe('parsley:form:validate', function (formInstance) {
                // if one of these blocks is not failing do not prevent submission
                // we use here group validation with option force (validate even non required fields)
                if (formInstance.isValid()) {
                    $("input[type=submit]").attr("disabled", "disabled");
                    $("#processing-modal").modal();
                    return;
                }
                // else stop form submission
                formInstance.submitEvent.preventDefault();
                $('.parsley-errors-list')
                        {#      .html("You must correctly fill the fields of at least one of these two blocks!")#}
                        .addClass("filled bootstrapError help-block");
            });
        };

        $(document).ready(function () {
            resetEditFormParsley();
            showProductModalIfErrors();
            setMaxModalHeight();
        });

        var changeItemPriceDataTypes = function() {
            document.getElementById("id_price").attributes["data-parsley-type"] = "decimal";
            document.getElementById("id_price").attributes["type"].value = "decimal";
        };


        var htmlString = "<div>\
          This is a string.\
        </div>";

        var colorQuantityTableHead = "" +
        "<div class='accordion-body collapse collapse-colors-quantity col-xs-12' style='padding-right: 0; padding-left: 6px; '>" +
            "<div class='accordion-inner table-responsive'>" +
                "<table class='table'>" +
                    "<thead>" +
                        "<tr>" +
                            "<td class='col-xs-8'><b>Color</b></td>" +
                            "<td class='col-xs-4'><b>Qty</b></td>" +
                        "</tr>" +
                    "</thead>" +
                    "<tbody>" +
                    "</tbody>" +
                "</table>" +
            "</div>" +
        "</div>";


        function sizeDimensionTemplate(required) {
            var sizeDimensionTemplate = "" +
            "<div id='sizeDimensionSelectionTemplate' class='accordion-group sizeDimensionSelectionTemplate'>" +
                "<div class='accordion-heading'><div id='div_id_sizeDimensionSelection' class='form-group'>" +
                    "<div class='controls row'>" +
                        "<div class='col-xs-4'>" +
                            "<input class='sizeDimensionSelection numberinput form-control dimensionWidth' id='id_sizeDimensionSelectionWidth' name='sizeDimWidth' type='decimal' placeholder = 'Type a width'" + required +">" +
                        "</div>" +
                        "<div class='col-xs-2 dimensionSplit'>X</div>"+
                        "<div class='col-xs-4'>" +
                            "<input class='sizeDimensionSelection numberinput form-control dimensionLength' id='id_sizeDimensionSelectionLength' name='sizeDimLength' type='decimal' placeholder = 'Type a length'" + required +">" +
                        "</div>" +
                        "<div class='col-xs-2'>" +
                            "<button id='id_clearSizes' class='shoppingcartBtn'  value='Clear' onclick='clearSizeRow(\"sizeDimensionSelectionTemplateTEMPLATENUM\")'>" +
                                "<img src='{{ STATIC_URL }}img/delete.png' width='20' height='20'/>" +
                            "</button>" +
                        "</div>" +
                    "</div>" +
                "</div>" +
            "</div>" + colorQuantityTableHead;
            return sizeDimensionTemplate;
        }

        function sizeNumberTemplate(required){
            var sizeNumberTemplate = "" +
            "<div id='sizeNumberSelectionTemplate' class='accordion-group sizeNumberSelectionTemplate'>" +
                "<div class='accordion-heading'><div id='div_id_sizeNumberSelection' class='form-group'>" +
                    "<div class='controls row'>" +
                        "<div class='col-xs-10'>" +
                            "<input class='sizeNumberSelection numberinput form-control'" + required + " id='id_sizeNumberSelection' name='sizeNumberSelection' type='decimal' placeholder = 'Type a size'>" +
                        "</div>" +
                        "<div class='col-xs-2'>" +
                            "<button id='id_clearSizes' value='Clear' class='shoppingcartBtn' onclick='clearSizeRow(\"sizeNumberSelectionTemplateTEMPLATENUM\")'>" +
                                "<img src='{{ STATIC_URL }}img/delete.png' width='20' height='20'/>" +
                            "</button>" +
                        "</div>" +
                    "</div>" +
                "</div>" +
            "</div>" + colorQuantityTableHead;
            return sizeNumberTemplate;
        }


        function oneSizeTemplate(required) {
            var oneSizeTemplate = "" +
            "<div id='oneSizeSelectionTemplate' class='accordion-group oneSizeSelectionTemplate'>" +
                "<div class='accordion-heading'><div id='div_id_oneSizeSelection' class='form-group'>" +
                    "<div class='controls row'>" +
                        "<div class='col-xs-10'>" +
                            "<input class='oneSizeSelection form-control' id='id_oneSizeSelection' name='oneSizeSelection' type='text' readonly value='No Size/ One Size Fits All'>" +
                        "</div>" +
                        "<div class='col-xs-2'>" +
                            "<button id='id_clearSizes' value='Clear' class='shoppingcartBtn' onclick='clearSizeRow(\"sizeNumberSelectionTemplateTEMPLATENUM\")'>" +
                                "<img src='{{ STATIC_URL }}img/delete.png' width='20' height='20'/>" +
                            "</button>" +
                        "</div>" +
                    "</div>" +
                "</div>" +
            "</div>" + colorQuantityTableHead;
            return oneSizeTemplate;
        }


        const SizeTypeInfo = {
            "1" :
            {
                "sizeTemplateClass" : ".sizeSetSelectionTemplate",
                "sizeSelectionClass" : ".sizeSetSelection",
                "selectedValueType" : '$("option:selected", this)'
            },
            "2" :
            {
                "sizeTemplateClass" : ".sizeDimensionSelectionTemplate",
                "sizeSelectionClass" : ".sizeDimensionSelection",
                "selectedValueType" : '$(this).val()'
            },
            "3" :
            {
                "sizeTemplateClass" : ".sizeNumberSelectionTemplate",
                "sizeSelectionClass" : ".sizeNumberSelection",
                "selectedValueType" : '$(this).val()'
            },
            "4":
            {
                "sizeTemplateClass" : ".oneSizeSelectionTemplate",
                "sizeSelectionClass" : ".oneSizeSelection",
                "selectedValueType" : '$(this).val()'
            }
        };

        function scrollToBottomOfProductCreationForm() {
            $('#productCreationForm').animate({scrollTop: $('#productCreationForm')[0].scrollHeight}, 500);
        }

        $(document).on('change','#id_sizeVariation',function(){
            var selectedValue = $("#id_sizeVariation option:selected");
            var sizesFieldSet = $("#sizesFieldSet");

            sizesFieldSet.removeClass("hidden");
            var sizeType = selectedValue[0].value;
            var sizeTypeString = sizeTypeStringFromNum(sizeType);
            var sizeTemplateClass = SizeTypeInfo[sizeType]['sizeTemplateClass'];
            var sizeSelectionClass = SizeTypeInfo[sizeType]['sizeSelectionClass'];
            var selectedValueType = SizeTypeInfo[sizeType]['selectedValueType'];

            RemoveWrongSizeTypes(sizeTypeString);
            addNewSizeRow(sizeTypeString);
            if (sizeTypeString != "oneSize"){
                wireEventHandlersForVariants(sizesFieldSet, sizeTypeString, sizeSelectionClass, sizeTemplateClass, selectedValueType, true);
            }
            else {
                wireEventHandlersForVariants(sizesFieldSet, sizeTypeString, sizeSelectionClass, sizeTemplateClass, selectedValueType, false);
            }

            scrollToBottomOfProductCreationForm();
        });

        function wireEventHandlersForVariants(sizesFieldSet, sizeTypeString, sizeSelectionClass, sizeTemplateClass, selectedValueType, addNewSize, repopulate) {
            //Size selection event handling (Add a color/quantity row, add a new size selector for more size selection)
            repopulate = repopulate || false
            if (addNewSize) {
                sizesFieldSet.on("change keyup", sizeSelectionClass, function (e) {

                    if ($(this).closest('.accordion-group').next().length == "0") {
                        addNewColorAndQuantityRow($(this).parents(sizeTemplateClass).attr("id") + "_", $(this).parents(".accordion-group").find("tbody"));
                    }

                    var selectedValue = eval(selectedValueType);
                    var sizesFieldSet = $("#sizesFieldSet");
                    if (selectedValue[0].value != "0") {
                        if ($(this).closest('.accordion-group').next().length == "0") {
                            //Add a new size set row
                            scrollToBottomOfProductCreationForm();
                            addNewSizeRow(sizeTypeString);
                        }
                    }
                });
            }
            else {
                if (!repopulate) {
                    if ($('#oneSizeSelectionTemplate0_id_oneSizeSelection').closest('.accordion-group').next().length == "0") {
                        addNewColorAndQuantityRow($("#oneSizeSelectionTemplate0_id_oneSizeSelection").parents(sizeTemplateClass).attr("id") + "_", $("#oneSizeSelectionTemplate0_id_oneSizeSelection").parents(".accordion-group").find("tbody"));
                    }
                    var sizesFieldSet = $("#sizesFieldSet");
                    if ($('#oneSizeSelectionTemplate0_id_oneSizeSelection').closest('.accordion-group').next().length == "0") {
                        scrollToBottomOfProductCreationForm();
                    }
                }
            }
            //Color event handling (Add a new color/quantity row for more color/quantity selection)
            sizesFieldSet.on("change", ".row-color", function(e) {
                var selectedValue = $("option:selected", this);
                var sizesFieldSet = $("#sizesFieldSet");
                var editorPanelHeight;
                var currentPanel;
                editorPanelHeight = .85;
                maxHeight = $(window).height()*editorPanelHeight;
                if (selectedValue[0].value != 0) {
                    var colorsAndQuantitiesTable = $(".table", $(this).parents(".accordion-group")[0]);
                    if($(this).closest('.rowColorQuantityTemplate').next().length == "0") {
                        addNewColorAndQuantityRow(colorsAndQuantitiesTable.parents(sizeTemplateClass).attr("id") + "_", colorsAndQuantitiesTable, false);
                        currentPanel = $(this).closest('.rowColorQuantityTemplate').next().position().top + $(this).closest(sizeTemplateClass).next().position().top - $(this).closest('.rowColorQuantityTemplate').next().height();
                        $('#productCreationForm').animate({scrollTop: currentPanel  }, 500);
                    }
                }
            })
        }

        var arSizeRows  = [] ;
        var arColorRows = [] ;
        var sizeRequired = "data-parsley-required='true' data-parsley-required-message='This field is required.' required";
        var sizeDimRequired = "data-parsley-required='true' data-parsley-required-message='This field is required.' data-parsley-type='number' data-parsley-type-digits-message='Enter a number.' data-parsley-type-number-message='Enter a number.'";
        var sizeNumRequired = "data-parsley-required='true' data-parsley-required-message='This field is required.' data-parsley-type='number' data-parsley-type-digits-message='Enter a number.' data-parsley-type-number-message='Enter a number.'";
        function clearColorRow( strRowToClear )
        {
            var strRowId = "#" + strRowToClear ;
            var indexToRemove = arColorRows.indexOf(strRowToClear) ;
            $(strRowId).remove();
            arColorRows.splice(indexToRemove, 1);
        }

        function clearSizeRow( strRowToClear )
        {
            var strRowId = "#" + strRowToClear ;
            var indexToRemove = arSizeRows.indexOf(strRowToClear) ;
            $(strRowId).remove();
            arSizeRows.splice(indexToRemove, 1);
        }

        function addNewSizeRow(sizeType) {
            var sizeTemplateName;
            var templateName;
            switch (sizeType) {
                case "sizeSet":
                    sizeTemplateName = "sizeSetSelectionTemplate";
                    templateName = sizeSetTemplate(sizeRequired);
                    sizeRequired="";
                    break;
                case "sizeDim":
                    sizeTemplateName = "sizeDimensionSelectionTemplate";
                    templateName = sizeDimensionTemplate(sizeDimRequired);
                    sizeDimRequired = "";
                    break;
                case "sizeNum":
                    sizeTemplateName = "sizeNumberSelectionTemplate";
                    templateName = sizeNumberTemplate(sizeNumRequired);
                    sizeNumRequired="";
                    break
                case "oneSize":
                    sizeTemplateName = "oneSizeSelectionTemplate";
                    templateName = oneSizeTemplate();
                    oneSizeRequired = "";
                    break
            }
            $("#sizesFieldSet").append(templateName);
            var $newSizeSelection = $("#"+sizeTemplateName);
            // Get the number at the end of the ID, increment it, and replace the old id
            var counter = GetNewCounter($newSizeSelection, sizeTemplateName, 0);
            appendSuffixToAttribute($newSizeSelection, "id", counter);

            //find TEMPLATENUM and replace it with the appropriate row number for clearing
            var newInnerHTML = $newSizeSelection.html().replace( "TEMPLATENUM", counter ) ;
            $newSizeSelection.html( newInnerHTML ) ;

            //If were working with a different size type we need to clear the array
            if( arSizeRows.length != 0 && arSizeRows[0].indexOf( sizeTemplateName ) == -1 )
            {
                arSizeRows = [] ;
            }
            arSizeRows[arSizeRows.length] = ( $( $newSizeSelection ).attr('id') ) ;

            // Find all elements in $clone that have an ID, and iterate using each()
            var prefix = $newSizeSelection[0].id + "_";
            $newSizeSelection.find('[id]').each(function() {
                 //Perform the same replace as above
                var $th = $(this);
                var newID = $th.attr('id').replace(/\w+$/, function(str) { return prefix + str; });
                $th.attr('id', newID);
            });

            // Find all elements in $clone that have a name, and iterate using each()
            $newSizeSelection.find('[name]').each(function() {
                 //Perform the same replace as above
                var $th = $(this);
                var newName = $th.attr('name').replace(/\w+$/, function(str) { return prefix + str; });
                $th.attr('name', newName);
            });
            return $newSizeSelection;
        }

        function addNewColorAndQuantityRow(prefix, appendTo, required) {
            if(typeof(required)==='undefined') required = true;

            var rowQtyRequired = "";
            if(required === true)
                rowQtyRequired ="data-parsley-required='true' data-parsley-required-message='This field is required.' required";

            var colorsAndQuantities = $(".collapse-colors-quantity", appendTo.parents(".accordion-group")[0]);
            colorsAndQuantities.collapse('show');

            $(appendTo).append(rowColorQuantityTemplate(rowQtyRequired));

            var $newColorQuantityRow = $("#rowColorQuantityTemplate");

            // Get the number at the end of the ID, increment it, and replace the old id
            var counter = GetNewCounter($newColorQuantityRow, "rowColorQuantityTemplate", 0);
            prependPrefixToAttribute($newColorQuantityRow, "id", prefix);
            appendSuffixToAttribute($newColorQuantityRow, "id", counter);

            //find TEMPLATENUM and replace it with the appropriate row number for clearing
            var newInnerHTML = $newColorQuantityRow.html().replace( "TEMPLATENUM", counter ) ;
            newInnerHTML = newInnerHTML.replace("rowColorQuantityTemplate", prefix + "rowColorQuantityTemplate" ) ;
            $newColorQuantityRow.html( newInnerHTML ) ;
            arColorRows[arColorRows.length] = ( $( $newColorQuantityRow ).attr('id') ) ;

            // Find all elements in $clone that have an ID, and iterate using each()
            $newColorQuantityRow.find('[id]').each(function() {
                //Perform the same replace as above
                var $th = $(this);
                var newID = $th.attr('id').replace(/\w+$/, function(str) { return prefix + str + counter; });
                $th.attr('id', newID);
            });

            // Find all elements in $clone that have a name, and iterate using each()
            $newColorQuantityRow.find('[name]').each(function() {
                 //Perform the same replace as above
                var $th = $(this);
                var newName = $th.attr('name').replace(/\w+$/, function(str) { return prefix + str + counter; });
                $th.attr('name', newName);
            });
            return $newColorQuantityRow;
        }

        function RemoveWrongSizeTypes(newSizeType) {
            switch (newSizeType) {
                case "sizeSet":
                    // Need to get parent and removeChild since IE does not support "remove()"
                    $(".sizeDimensionSelectionTemplate").each(function() {
                        $(this).remove();
                    });
                    $(".sizeNumberSelectionTemplate").each(function() {
                         $(this).remove();
                    });
                    $(".oneSizeSelectionTemplate").each(function() {
                         $(this).remove();
                    });
                    break;
                case "sizeDim":
                    $(".sizeSetSelectionTemplate").each(function() {
                         $(this).remove();
                    });
                    $(".sizeNumberSelectionTemplate").each(function() {
                         $(this).remove();
                    });
                    $(".oneSizeSelectionTemplate").each(function() {
                         $(this).remove();
                    });
                    break;
                case "sizeNum":
                    $(".sizeSetSelectionTemplate").each(function() {
                         $(this).remove();
                    });
                    $(".sizeDimensionSelectionTemplate").each(function() {
                         $(this).remove();
                    });
                    $(".oneSizeSelectionTemplate").each(function() {
                         $(this).remove();
                    });
                    break
                case "oneSize":
                    $(".sizeSetSelectionTemplate").each(function() {
                         $(this).remove();
                    });
                    $(".sizeDimensionSelectionTemplate").each(function() {
                         $(this).remove();
                    });
                    $(".sizeNumberSelectionTemplate").each(function() {
                         $(this).remove();
                    });
                    break
            }
        }

        function GetNewCounter($element, classFromPrevious, initial){
            var counter = initial;
            var numberAtEndOfId;
            if($element.prev().hasClass(classFromPrevious))
            {
                if(numberAtEndOfId = $element.prev().attr('id').match(/(\d+)$/))
                {
                    counter = parseInt(numberAtEndOfId[0], 10) + 1;
                }
            }
            return counter;
        }

        function ReplaceNumberAtEndOfString(string, newNumber) {
            var newString = string.replace(/[_0-9]+$/, newNumber);
            return newString
        }

        function appendSuffixToAttribute(element, attr, suffix){
            element.attr(attr, element.attr(attr) + suffix);
        }

        function prependPrefixToAttribute(element, attr, prefix){
            element.attr(attr, prefix + element.attr(attr));
        }

        function sizeTypeStringFromNum(num) {
            switch (num) {
                case "1":
                    return "sizeSet";
                case "2":
                    return "sizeDim";
                case "3":
                    return "sizeNum";
                case "4":
                    return "oneSize";
                default:
                    return "";
            }
        }

        function populateProductVariantsInfo(ajaxurl) {

            $.getJSON(ajaxurl+"/getVariants/size", function(data) {
                var sizeType = data["sizetype"];
                var sizeTypeString = sizeTypeStringFromNum(sizeType);
                var sizeTemplateClass = SizeTypeInfo[sizeType]['sizeTemplateClass'];
                var sizeSelectionClass = SizeTypeInfo[sizeType]['sizeSelectionClass'];
                var selectedValueType = SizeTypeInfo[sizeType]['selectedValueType'];

                var sizesFieldSet = $("#sizesFieldSet");
                sizesFieldSet.removeClass("hidden");
                if (sizeTypeString != "oneSize"){
                    wireEventHandlersForVariants(sizesFieldSet, sizeTypeString, sizeSelectionClass, sizeTemplateClass, selectedValueType, true);
                }
                else {
                    wireEventHandlersForVariants(sizesFieldSet, sizeTypeString, sizeSelectionClass, sizeTemplateClass, selectedValueType, false, true);
                }

                $.each(data.variants, function(key, value) {
                    var sizeRow = addNewSizeRow(sizeTypeString);
                    populateInitialDataForSizeRow(sizeRow, sizeTypeString, key);
                    var prefix = sizeRow.attr("id") + "_";
                    var appendTo = sizeRow.find("tbody");
                    $.each(value, function (key, value) {

                        var colorQuantityRow = addNewColorAndQuantityRow(prefix, appendTo);
                        populateInitialDataForColorAndQuantityRow(colorQuantityRow, value.color, value.quantity);
                    });
                    addNewColorAndQuantityRow(prefix, appendTo, false);
                });
                if (sizeTypeString != "oneSize") {addNewSizeRow(sizeTypeString);}
            });
        }

        function populateInitialDataForSizeRow(sizeRow, sizeType, size) {
            switch (sizeType) {
                case "sizeSet":
                    sizeRow.find('.sizeSetSelection option').each(function() {
                      if($(this).text() == size.toUpperCase()) {
                        $(this).attr('selected', 'selected');
                      }
                    });
                    break;
                case "sizeDim":
                    var dims = size.split(" x ");
                    sizeRow.find('.dimensionWidth').val(dims[0]);
                    sizeRow.find('.dimensionLength').val(dims[1]);
                    break;
                case "sizeNum":
                    sizeRow.find('.sizeNumberSelection').val(size);
                    break;
                case "oneSize":
                    sizeRow.find('.oneSizeSelection').val("No size/ One size fits all");
                    break;
            }
        }

        function populateInitialDataForColorAndQuantityRow(colorQuantityRow, color, quantity) {
            colorQuantityRow.find('.colorSelect option').each(function() {
              if($(this).text() == color) {
                $(this).attr('selected', 'selected');
              }
            });
            colorQuantityRow.find('.quantityField').val(quantity);
        }

        var jsonDel, delState;
        $('.itemDelete').click(function (e) {
            var chevron, jsonDel, parentId, delState;
            delState = sessionStorage.getItem("del-state");
            jsonDel = JSON.parse(delState || "{}");
            parentId = "editorPanels";
            chevron = "false";
            jsonDel[parentId] = chevron;

            return sessionStorage.setItem("del-state", JSON.stringify(jsonDel));
        });

        delState = sessionStorage.getItem("del-state");
        jsonDel = JSON.parse(delState || "{}");

        $(function () {
            $.each(jsonDel, function (containerId, isHidden) {
                if (isHidden === "false") {
                    $("#minMaxIcon").removeClass("glyphicon-chevron-down");
                    $("#minMaxIcon").addClass("glyphicon-chevron-up");
                    sessionStorage.removeItem("del-state");
                    return $("#" + containerId).collapse('hide');
                }
                else {
                    return $("#" + containerId).collapse('show');
                }
            });
        });

        var json, tabsState;
        $('a[data-toggle="pill"]').click(function (e) {
            var href, json, parentId, tabsState;

            tabsState = sessionStorage.getItem("tabs-state");
            json = JSON.parse(tabsState || "{}");
            parentId = $(e.target).parents("ul.nav.nav-pills").attr("id");
            href = $(e.target).attr('href');
            json[parentId] = href;

            return sessionStorage.setItem("tabs-state", JSON.stringify(json));
        });

        tabsState = sessionStorage.getItem("tabs-state");
        json = JSON.parse(tabsState || "{}");

        $.each(json, function (containerId, href) {
            return $("#" + containerId + " a[href=" + href + "]").tab('show');
        });

        function getCenterBoxSelection(ratio_width, ratio_height, image_width, image_height) {

            var ratio = ratio_width / ratio_height;
            if (image_width < image_height * ratio) {
                // width fits fully, height needs to be cropped
                offset = Math.round((image_height - (image_width / ratio)) / 2);
                return [0, offset, image_width, image_height - offset]
            }
            // height fits fully, width needs to be cropped
            var offset = Math.round((image_width - (image_height * ratio)) / 2);
            return [offset, 0, image_width - offset, image_height];
        }

        function readURL(input, cropping_img, ratio_width, ratio_height) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function (e) {
                    if (cropping_img in jcrop) {
                        var thumbnail = $('#' + cropping_img).next('.jcrop-image').children('img');
                        var img = new Image();
                        img.src = reader.result;
                        jcrop[cropping_img].setImage(reader.result, function () {
                            this.setOptions({
                                aspectRatio: ratio_width / ratio_height,
                                setSelect: getCenterBoxSelection(ratio_width, ratio_height, img.width, img.height),
                                trueSize: [img.width, img.height]
                            });
                        })
                    }
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        $("#id_banner").change(function () {
            readURL(this, 'id_bannerCropping-image', 1779, 364);
        });

        $("#id_mobileBanner").change(function () {
            readURL(this, 'id_mobileBannerCropping-image', 968, 642);
        });

        $("#id_aboutImg").change(function () {
            readURL(this, 'id_aboutImgCropping-image', 155, 155);
        });

        $(document).on("change","#id_images-0-original",function(){
            {#        $('#product_image_preview ').parent().prev('.docs-toolbar').removeClass('hidden');#}
            readURL(this, 'id_images-0-cropping-image', 400, 400);
            $('#div_id_images-1-original').removeClass("hidden");
            $('#div_id_images-1-cropping').removeClass('hidden');
            $('#div_id_images-1-DELETE').removeClass('hidden');
        });
        $(document).on("change","#id_images-1-original",function(){
            readURL(this, 'id_images-1-cropping-image', 400, 400);
            $('#div_id_images-2-original').removeClass("hidden");
            $('#div_id_images-2-cropping').removeClass('hidden');
            $('#div_id_images-2-DELETE').removeClass('hidden');
        });
        $(document).on("change","#id_images-2-original",function(){
            readURL(this, 'id_images-2-cropping-image', 400, 400);
            $('#div_id_images-3-original').removeClass("hidden");
            $('#div_id_images-3-cropping').removeClass('hidden');
            $('#div_id_images-3-DELETE').removeClass('hidden');
        });
        $(document).on("change","#id_images-3-original",function(){
            readURL(this, 'id_images-3-cropping-image', 400, 400);
            $('#div_id_images-4-original').removeClass("hidden");
            $('#div_id_images-4-cropping').removeClass('hidden');
            $('#div_id_images-4-DELETE').removeClass('hidden');
        });
        $(document).on("change","#id_images-4-original",function(){
            readURL(this, 'id_images-4-cropping-image', 400, 400);
        });


        function showImageFields() {
            {#        $('#product_image1_preview ').parent().prev('.docs-toolbar').removeClass('hidden');#}
            $('#div_id_images-1-original').addClass('hidden');
            $('#div_id_images-2-original').addClass('hidden');
            $('#div_id_images-3-original').addClass('hidden');
            $('#div_id_images-4-original').addClass('hidden');

            $('#div_id_images-1-cropping').addClass('hidden');
            $('#div_id_images-2-cropping').addClass('hidden');
            $('#div_id_images-3-cropping').addClass('hidden');
            $('#div_id_images-4-cropping').addClass('hidden');

            $('#div_id_images-1-DELETE').addClass('hidden');
            $('#div_id_images-2-DELETE').addClass('hidden');
            $('#div_id_images-3-DELETE').addClass('hidden');
            $('#div_id_images-4-DELETE').addClass('hidden');


            var visibleImages = [
                $('#div_id_images-0-original a[target="_blank"]').length,
                $('#div_id_images-1-original a[target="_blank"]').length,
                $('#div_id_images-2-original a[target="_blank"]').length,
                $('#div_id_images-3-original a[target="_blank"]').length
            ];

            if (visibleImages[0]) {
                $('#div_id_images-1-original').removeClass("hidden");
                $('#div_id_images-1-cropping').removeClass('hidden');
                $('#div_id_images-1-DELETE').removeClass('hidden');
            }
            if (visibleImages[1]) {
                $('#div_id_images-2-original').removeClass("hidden");
                $('#div_id_images-2-cropping').removeClass('hidden');
                $('#div_id_images-2-DELETE').removeClass('hidden');
            }
            if (visibleImages[2]) {
                $('#div_id_images-3-original').removeClass("hidden");
                $('#div_id_images-3-cropping').removeClass('hidden');
                $('#div_id_images-3-DELETE').removeClass('hidden');
            }
            if (visibleImages[3]) {
                $('#div_id_images-4-original').removeClass("hidden");
                $('#div_id_images-4-cropping').removeClass('hidden');
                $('#div_id_images-4-DELETE').removeClass('hidden');
            }
        }

        $(document).ready(function () {
            var mode = checkMode();
            if (mode == 'xs' || mode == 'sm') {

                var showMobile = sessionStorage.getItem('showMobile');
                if (showMobile == null || showMobile == 'true') {
                    sessionStorage.setItem('showMobile', 'false');
                    $('#mobileModal').modal('show');
                }
            }
        });

        var currentEditForm = "";
        $(document).on("click",".overlayEdit, .addItem",function(){
            var thisClick = $(this);
            if ($(this).attr('data-navigation') != currentEditForm) {
                $('#processing-modal').modal();
                var ajaxurl = $(this).attr("data-navigation");
                tinyMCE.execCommand('mceRemoveControl', true, "id_description")
                $.each(jcrop, function() {
                    this.destroy();
                });
                $("img[style*='display: block']").remove();
                $("#productCreationForm").load(ajaxurl + " #productCreationForm form", function (){
                    if (thisClick.hasClass('overlayEdit')) { populateProductVariantsInfo(ajaxurl); }
                    resetEditFormParsley();
                    tinyMCE.execCommand('mceAddControl', true, "id_description");
                    currentEditForm = thisClick.attr('data-navigation');
                    image_cropping.init();
                    $('#processing-modal').modal('hide');
                    showProductModal();
                });
            }
            else
            {
                showProductModal();
            }
        });

        var showProductModalIfErrors = function(){
            if($('#productCreationModal .alert-danger').length > 0 || $('#productCreationModal .help-block').length > 0){
                showProductModal();
            }
        };

        var showProductModal = function(){
            showImageFields();
            changeItemPriceDataTypes();
            setMaxModalHeight();
            $('#productCreationModal').modal();
        }

        $(window).resize(function (){
            setMaxModalHeight();
        });

        var setMaxModalHeight = function () {
            heightToSubtract =
            $(".modal-body").css('max-height', ($(window).height() *.9 - 140) + 'px');
        }

        $(document).on('mousedown','.colorSelect',function(){
            var colors = []
            $('[id^=' + this.id.replace(/\d+$/, "") +']').each(function() {
                colors.push($(this).val())
            });

            for(i=0; i<colors.length; i++) {
                if (colors[i] !== '' && colors[i] !== $(this).val()) {
                    $('#' + this.id + ' option[value=' + colors[i] + ']').remove()
                }
            }
        });

        $(document).on('mousedown','.sizeSetSelection',function(){
            var sizes = []
            $('[id$=id_sizeSetSelection]').each(function() {
                sizes.push($(this).val())
            });

            for(i=0; i<sizes.length; i++) {
                if (sizes[i] !== '' && sizes[i] !== $(this).val()) {
                    $('#' + this.id + ' option[value=' + sizes[i] + ']').remove()
                }
            }
        });

    </script>
{% endblock %}

{% block uncompressable_js %}
    {{ block.super }}
    <script>
    function DeleteConfirmation(slug) {
            $('#deleteModal').modal('show');
            $('#okDeleteBtn').click({param1: slug}, function (event) {
                var href = "{{ shop.get_absolute_url }}edit/delete_product/";
                window.location = href + event.data.param1;
            });
        }

    function sizeSetTemplate(required) {
            var sizeSetTemplate = "" +
            "<div id='sizeSetSelectionTemplate' class='accordion-group sizeSetSelectionTemplate'>" +
                "<div class='accordion-heading'><div id='div_id_sizeSetSelection' class='form-group'>" +
                    "<div class='controls row'>" +
                        "<div class='col-xs-10'>" +
                            "<select class='sizeSetSelection select form-control' id='id_sizeSetSelection' name='sizeSetSelection' " + required + ">" +
                                "<option value='' selected='selected'>Choose a size...</option>" +
                                "{% for sizeSet in sizeSetOptions %}" +
                                    "<option value='{{sizeSet.id}}'>{{sizeSet.option|upper}}</option>" +
                                "{% endfor %}" +
                            "</select>" +
                        "</div>" +
                        "<div class='col-xs-2'>" +
                            "<button id='id_clearSizes' class='shoppingcartBtn' value='Clear' onclick='clearSizeRow(\"sizeSetSelectionTemplateTEMPLATENUM\")'>" +
                                "<img src='{{ STATIC_URL }}img/delete.png' width='20' height='20'/>" +
                            "</button>" +
                        "</div>" +
                    "</div>" +
                "</div>" +
            "</div>" + colorQuantityTableHead;
            return sizeSetTemplate;
        }

    function rowColorQuantityTemplate(required){
            dataType = "data-parsley-type='number' data-parsley-min='0' data-parsley-type-digits-message='Enter a number.' data-parsley-type-number-message='Enter a number.'";
            numRequired = "data-parsley-required='true' data-parsley-required-message='This field is required.'" + dataType;
            if (required === "")
                numRequired = "data-parsley-type='number' data-parsley-min='0' data-parsley-type-digits-message='Enter a number.' data-parsley-type-number-message='Enter a number.'";
            var rowColorQuantityTemplate = "" +
            "<tr class='row-color-quantity rowColorQuantityTemplate' id='rowColorQuantityTemplate'>" +
                "<td style=' padding: 8px 2px 0px 2px; '>" +
                    "<div class='row-color >" +
                        "<div id='div_id_colorSelection' class='form-group'>" +
                            "<div class='controls'>" +
                                "<select class='select form-control colorSelect'" + required + " id='id_colorSelection' name='colorSelection' placeholder='Choose a color'>" +
                                    "<option value='' selected='selected'>Choose a color...</option>" +
                                    "{% for color in colors %}" +
                                    "<option value='{{color.id}}'>{{color.option|capfirst}}</option>" +
                                    "{% endfor %}" +
                                "</select>" +
                            "</div>" +
                        "</div>" +
                    "</div>" +
                "</td>" +
                "<td style=' padding: 8px 0px 0px 0px; '>" +
                    "<div id='div_id_quantityField' class='form-group'>" +
                        "<div class='controls'>" +
                            "<input class='numberinput form-control quantityField'" + numRequired +  "id='id_quantityField' name='quantityField' type='number' value='1'>" +
                        "</div>" +
                    "</div>" +
                "</td>" +
                "<td style=' padding: 8px 0px 0px 0px; '>" +
                    "<button id='id_clearColorQuantity' value='Clear' class='shoppingcartBtn' onclick='clearColorRow(\"rowColorQuantityTemplateTEMPLATENUM\")'>" +
                        "<img src='{{ STATIC_URL }}img/delete.png' width='20' height='20' />" +
                    "</button>" +
                "</td>" +
            "</tr>";
            return rowColorQuantityTemplate;
        }
    </script>


{% endblock uncompressable_js %}
