
    {% extends "base.html" %}
    {% block content %}
    <div class="container">
        <div align="center"><font size="12" color="f46430">Tinville</font></div>

        <div class="container">
        <!-- load items dynamically <div align="center" id="checkoutcartitems" class="col-xs-12 col-md-10 col-lg-10 col-xl-10"></div>-->
            <table class="table table-hover table-condensed">
                <thead>
                <tr>
                    <th style="width:50%">Product</th>
                    <th style="width:10%">Price</th>
                    <th style="width:8%">Quantity</th>
                    <th style="width:22%" class="text-center">Subtotal</th>
                    <th style="width:10%"></th>
                </tr>
                </thead>
                <tbody id="checkoutcartitems">
                </tbody>
                <tfoot>
                <tr class="visible-xs">
                    <td class="text-center"><strong id="checkoutTotalMobile">Total: </strong></td>
                </tr>
                <tr>
                    <td><a href="{% url 'home' %}" class="btn btn-warning"><i class="fa fa-angle-left"></i> Continue Shopping</a></td>
                    <td colspan="2" class="hidden-xs"></td>
                    <td class="hidden-xs text-center"><strong id="checkoutTotal">Total: </strong></td>
                    <td><a href="#" id="paypalBtn" class="btn btn-success btn-block">Checkout <i class="fa fa-angle-right"></i></a></td>
                </tr>
                </tfoot>
            </table>
        </div>
    </div>

<script>
    $(function() {
        LoadCheckoutCartDivs();
        aggregateCheckoutTotal();
    });

function LoadCheckoutCartDivs()
{
    var url = "/load_cart"
    ajax_req = $.ajax({
        url: url,
        type: "GET",
        dataType: 'json',
        success: function(data, textStatus, jqXHR) {
            $.each(data, function(index, item)
            {
                if (item.msg == ''){
                    item.image = "{{ MEDIA_URL }}" + item.image
                    LoadCheckoutCartDiv(item)
                }
                else {
                    $('#messageId').html(item.msg)
                    $('#messageModal').modal('show');
                }
            });
        },
        error: function(data, textStatus, jqXHR) {
        }
    });
}

    function LoadCheckoutCartDiv(cartItem)
    {
        var cartitemtr =  $('<tr/>', {
            'id' : cartItem.Id
        });

        var cartitemtd = $('<td/>', {'data-th' : 'Product' });

        var cartprodrow = $('<div/>', {'class':'row'});

        var itemThumbnail = $('<img/>', {'src':cartItem.image, 'class': 'img-responsive'});
        var thumbnailDiv = $('<div/>', {'class': 'col-sm-2 hidden-xs'});
        itemThumbnail.appendTo(thumbnailDiv);
        thumbnailDiv.appendTo(cartprodrow);
        cartprodrow.appendTo(cartitemtd);

        var itemInfoDiv = $('<div/>', {'class' : 'col-sm-10'});

        var itemTitle = $('<h4/>', {'class':'nomargin','text':cartItem.title});
        itemTitle.appendTo(itemInfoDiv);

        var itemDescription = $('<p/>', {'text':cartItem.description});
        itemDescription.appendTo(itemInfoDiv);

        itemInfoDiv.appendTo(cartprodrow);
        cartitemtd.appendTo(cartitemtr);
        var price = '$' + cartItem.price;
        var priceDiv = $('<td/>', {'id': 'id_price_' + cartItem.product_id,'data-th' : 'Price', 'text': price});
        priceDiv.appendTo(cartitemtr);

        var qtyTd = $('<td/>', {'data-th' : 'Quantity'});
        var qtyInputDiv = $('<input/>', {'class': 'form-control text-center', 'type' : 'number', 'min':'1', 'max': cartItem.currentStock, 'value' : cartItem.qty, 'onchange' : 'AddCheckoutItemQuantity(this, ' + cartItem.product_id + ')'});
        qtyInputDiv.appendTo(qtyTd);
        qtyTd.appendTo(cartitemtr);

        var actions  = $('<td/>', {'class':'actions', 'data-th': ''});
        var delBtnId = 'deleteBtnId_' + cartItem.Id;

        var removeBtn = $('<button/>', { 'type' : 'button', 'onclick' : 'RemoveCheckoutItem(' + cartItem.Id + ')', 'id' : delBtnId,
            'class' : 'shoppingcartBtn', 'html' : '<img src="{{ STATIC_URL }}img/delete.png" width="20" height="20">'
        });
        removeBtn.appendTo(actions);
        actions.appendTo(cartitemtr);

        cartitemtr.appendTo("#checkoutcartitems");
    }

    function RemoveCheckoutItem(Id)
    {
        RemoveCartItem(Id);
        $('#'+Id).remove();
        aggregateCheckoutTotal();
    }

    function AddCheckoutItemQuantity(event, id)
    {
        var url = "/update_cart_item"
        ajax_req = $.ajax({
            url: url,
            type: "POST",
            data: {
                "product_id" : id,
                "quantity" : event.value
            },
            success: function(data, textStatus, jqXHR) {
                $('#id_price_'+id).text('$'+data.price);
                $('#checkoutTotal').text('Total: $' + data.total);
            },
            error: function(data, textStatus, jqXHR) {
            }
        });

        aggregateCheckoutTotal();
    }

    function aggregateCheckoutTotal()
    {
        var url = "/cart_total"
        ajax_req = $.ajax({
            url: url,
            type: "GET",
            success: function(data, textStatus, jqXHR) {
                $('#checkoutTotal').text('Total: $' + data.total);
                $('#checkoutTotalMobile').text('Total: $' + data.total);
            },
            error: function(data, textStatus, jqXHR) {
            }
        });
    }
</script>
    {% endblock %}