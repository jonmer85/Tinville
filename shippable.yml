language: python

python:
  - 2.7
addons:
  firefox: "27.0"

env:
  global:
    - secure: WyuLGuiXsvD70hljRXPEVmsUXwK8tzcyIjewzuefkjR+xCQJ7iD2cvUyMDSasjz4l3RuP9d94DEx9oRf5zUfAApaPx1BuOEW5uJ4yqRSAAgR5OnGH3+xx5LFNQv7zmxlVw6Or8L51mkI36xcUGoKiJZv6GhnILg7zgRS1WH2Mkd2Wdo/8DofF0Rg7BL6vJJn16o9dv6OC5R9SrujwqupiIJxmHOtwqc/sQXFECwde6qIpNwuTdEMRFF46SL3cMG7IDR61W47KqzDEJMDhuFH0vpsvpkqqM8LjqVeLbnfJyworSNyb+8xxSze7q43OHwWWu9aRCWCQTz6Caal8tUYbIE5SLB6HouZIAce4QJVj3IQC6y6GlfTQ1BdbgQOopOR31hd0pRV3Rq8zTcBwM7eVIaVQAH0mg9TFMGw6OiFR4WFDmC8BsA+kI49NV5jHSZ69v7cP70aH/lD4TdSD7CwlEzpl4UG8QbsBrmTo+WBGCqp3TvPW++gf9YsG9HxGYZlHjCoGIF+tAxcYoZiNvXloUu0mkoXSFZ4swUCZdwl/z/GAcZuwD+p3nIDrie/TEp8njR2wCCqPnupLKK1L95Z1Srtx6TNfBQ1YieApo7vrhGN2h5mk0w/pcjFMcYnBevBSXJpNgtfQS+Er8/bEUAcW3/9iLQTOaQgh3rgLtnCeO0=
    - DISPLAY=:99.0

before_install:
  - . $HOME/.rvm/scripts/rvm && rvm use ruby-2.0.0-p598 --default && ruby --version
  - which heroku || wget -qO- https://toolbelt.heroku.com/install-ubuntu.sh | sh

install:
  - pip install -r requirements.txt

before_script:
  - mkdir -p shippable/testresults
  - mkdir -p shippable/codecoverage
#  - mysql -e 'create database test;'
  - /etc/init.d/xvfb start

script:
  - ./initDataNoInput lettuce_tests
  - coverage run --source='Tinville,basket,common,designer_shop,extensions,custom_oscar.apps.catalogue,custom_oscar.apps.checkout,custom_oscar.apps.customer,custom_oscar.apps.order,custom_oscar.apps.dashboard,user' manage.py harvest --with-xunit --xunit-file=shippable/testresults/lettucetests.xml --settings=Tinville.settings.lettuce_tests
  - coverage xml -o shippable/codecoverage/coverage_lettuce.xml
  - coverage run --source='Tinville,basket,common,designer_shop,extensions,custom_oscar.apps.catalogue,custom_oscar.apps.checkout,custom_oscar.apps.customer,custom_oscar.apps.order,custom_oscar.apps.dashboard,user' manage.py test --with-xunit --xunit-file=shippable/testresults/unittests.xml --settings=Tinville.settings.unit_tests
  - coverage xml -o shippable/codecoverage/coverage_unittests.xml

after_script:
  - /etc/init.d/xvfb stop

after_success :
  - echo $BRANCH
  - test -f ~/.ssh/id_rsa.heroku || ssh-keygen -y -f ~/.ssh/id_rsa > ~/.ssh/id_rsa.heroku && heroku keys:add ~/.ssh/id_rsa.heroku
  - ./deploy.sh
