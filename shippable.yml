language: python

python:
  - 2.7
addons:
  firefox: "27.0"

env:
  global:
    - DISPLAY=:99.0

install:
  - pip install -r requirements.txt

before_script:
  - mkdir -p shippable/testresults
  - mkdir -p shippable/codecoverage
#  - mysql -e 'create database test;'
  - /etc/init.d/xvfb start

script:
  - ./test reset_db --noinput
  - ./initDataNoInput test
  - coverage run --source='Tinville,basket,common,designer_shop,extensions,catalogue,user' manage.py harvest --with-xunit --xunit-file=shippable/testresults/lettucetests.xml --settings=Tinville.settings.test
  - coverage xml -o shippable/codecoverage/coverage_lettuce.xml
  - coverage run --source='Tinville,basket,common,designer_shop,extensions,catalogue,user' manage.py test --with-xunit --xunit-file=shippable/testresults/unittests.xml --settings=Tinville.settings.test
  - coverage xml -o shippable/codecoverage/coverage_unittests.xml

after_script:
  - /etc/init.d/xvfb stop

after_success :
  - >
    [[ $BRANCH = 'Sprint6' ]] && git push -f git@heroku.com:tinville-testing.git Sprint6:master && ./initDataNoInput qatest && ./qatest collectstatic --noinput
  - >
    [[ $BRANCH = 'Sprint6' ]] && git push -f git@heroku.com:tinville-dev.git Sprint6:master && ./initDataNoInput dev && ./dev collectstatic --noinput
